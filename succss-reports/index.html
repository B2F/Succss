<!DOCTYPE html>
<html ng-app="succssReportsApp">
  <head>
    <title>Succss reports</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script type="text/javascript" src="runs.json.inc"></script>
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:700" rel="stylesheet" type="text/css">
    <style type="text/css">
      body { position:relative; background-color: #EEEFF0; margin-top: 87px; font-family: Roboto; margin-bottom: 70px; }
      .page-load-error { color: #F00; font-size: 1.3em; margin: 3%;}
      header { top: 0; left: 0; color: #F5F5C4; }
      header, footer { position: fixed; height:65px; width:100%; background-color: #1C424F; z-index: 1000; font-family: Open Sans; }
      header h1 { position: relative; left: 11px; bottom: 36px; font-size: 47px; width: 350px; z-index:1; cursor:pointer; }
      header div.links { position: absolute; padding-left: 371px; border-bottom: 2px solid #F5F5C4; bottom: 1px;}
      header div.links div div { position:relative; text-align: center; background-color:#EBEAE1; border-radius: 2px 2px 0 0; display: inline-block; }
      header div.links div div a { text-decoration: none; text-align: center; color: #3A3A3A; font-size: 13px; display:block; width: 100px; padding: 4px; }
      header div.links div div a.active { font-size: 16px; color: black; }
      #rowLimit { padding: 0 0 10px 0; }
      #rowLimit input { position: relative; width: 44px; bottom: 1px; margin-left: 3px; z-index:0; }
      table { font-family: sans-serif; margin-top: 10px; border-spacing: 0px; width: 98%; table-layout: fixed; overflow: hidden; }
      table#report-list tbody, div#active-reference-list tbody td .details { font-size: 11px; }
      table thead { line-height: 2.3; background-color: #FFE; font-size: 12px; }
      table thead th { border-bottom: 1px solid #777; }
      table thead .search.timestamp { width: 125px; position:relative; }
      table thead .search.timestamp button { position:relative; left: 5px; margin-left: 1px; padding-left: 3px; width: 20px; }
      table thead .search.date { width: 115px; }
      table thead .search.config { width: 125px; }
      table thead .search.status { width: 67px; }
      table tbody tr:first-child, #active-reference-list table tbody tr { background-color: #FFFFCF; }
      table tbody tr input, table tbody tr select { width: 95%; margin-right: 1%; font-size: 10px; }
      table tbody tr button { width: 25px; }
      table th, td { padding: 5px 7px ; border-bottom: 1px solid #EEEFF0; border-right: 1px dotted #EEEFF0; }
      table tbody tr { text-align: left; line-height: 1.5; cursor: pointer; }
      table tr.success { background-color: #C7FFC8; }
      table tr.failure { background-color: #FF9CB5; }
      table tr.success.active { background-color: #B2F1B2; font-weight: bold; }
      table tr.failure.active { background-color: #F78FAB; font-weight: bold; }
      table tr.success.hovered, table tr.failure.hovered { background-color: #FCFFC7; }
      div.current-report-title span, h3 { margin: 15px 0; font-size: 20px; padding-bottom: 5px; border-bottom: 1px solid black; display: inline-block; cursor: pointer; }
      div#current-report-description > div { display: inline-block; height: 150px; margin-top: 5px; overflow: hidden; border-left: 1px solid black; padding: 0px 0px 0px 11px; }
      div#current-report-description > div#current-report-summary { font-size: 18px; min-width: 300px; width: 25%; overflow-y: auto; }
      div#current-report-description > div#current-report-summary span.success { color: #0C0; font-family: sans-serif; font-weight:bold; }
      div#current-report-description >  div#current-report-summary span.failure { color: #C00; font-family: sans-serif; font-weight:bold; }
      div#current-report-description > div#current-report-summary .report-error { font-size: 11px; color: #C00; padding: 2px 35px 3px 0px; }
      div#current-report-description > div#current-report-options { min-width: 470px; width: 71%; }
      div#current-report-description > div#current-report-options h4 { margin: 0; color: white; background-color: #214F5E; padding: 3px 0 5px 6px; }
      div#current-report-description > div#current-report-options div.options-list { line-height: 1.3; overflow-y: auto; height: 115px; display: block; color: white; background-color: #307389; padding: 4px 5px; border-bottom: 1px dotted #214F5E; font-family: sans-serif; }
      div#active-check-report div.current-report-captures { width: 50%; float: left; margin: 7px 0 71px 0; }
      div#active-check-report div.current-report-captures div.difference { border-left: 2px solid black; padding: 0 0 12px 7px; font-family: sans-serif; font-size:13px; }
      div#active-check-report div.current-report-captures h4 { font-size: 14px; margin: 0; }
      div.active-report { margin: 24px 0; }
      div.current-report-captures div.difference a img, td.image-reference a img { max-width: 97%; max-height: 300px; }
      div#active-reference-list table th:not(image-reference) { width: 11%; }
      div#active-reference-list table th.image-reference { width: auto; }
      div#active-reference-list table td { text-align: center; vertical-align: top; font-size: 12px; }
      footer { height: 45px; bottom: 0; left: 0 }
      footer a { color:white; text-decoration:none; font-size: 13px; display: inline-block; padding: 11px 0; }
      footer a.documentation-root { color: #F5F5C4; font-size: 17px ; text-decoration: underline; padding-left: 12px; padding-right: 6px; }
      footer img.footer-logo { transition: all 1s ease-in-out; transition-timing-function: cubic-bezier(42,0,.58,1); }
      footer:hover img.footer-logo { transform:translateY(-58px); opacity: 0.7; }
      footer img.footer-logo { position:absolute; float:right; right: 11px; bottom: -90px; }
      footer div { border-top: 1px solid #F5F5C4; }
    </style>
  </head>
  <body ng-controller="ReportsListCtrl">

    <div ng-show="false" class="page-load-error">
      Succss reporting functionality requires Angularjs 1.3.14. Either type the following in your working succss directory:
      <pre>npm install angular@1.3.14</pre>
      Or get network access to https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angulars.min.js.
    </div>

    <header>
      <h1 ng-click="scrollTop()" title="Scroll back top">Succss reports</h1>
      <div class="links">
        <div class="links-container">
          <div><a href="#/check" ng-click="switchPage('check')" ng-class="{active:checkPageActive}">Check</a></div>
          <div><a href="#/add" ng-click="switchPage('add')" ng-class="{active:referencesPageActive}">References</a></div>
        </div>
      </div>
    </header>

    <div id="rowLimit"><label>Reports row limit: </label><input ng-model="rowLimit" placeholder={{defaultRowLimit}} type="number"></div>
    <!--<div id="dataFile"><label>Data file:</label><input type="text"  /></div>-->

    <table id="report-list">
      <thead>
        <th class="search timestamp">Timestamp <button ng-click="reverseReportsOrder()" title="Reverse order by date">R</button></th>
        <th class="search date">Date</th>
        <th class="search config">Config file</th>
        <th class="search status">Status</th>
        <th class="search pages">--pages</th>
        <th class="search viewports">--viewports</th>
        <th class="search captures">--captures</th>
      </thead>
      <tbody>
        <tr>
          <th><input ng-model="search.timestamp"></th>
          <th><input ng-model="search.date" placeholder="{{ '<= ' + (now | date:'d MMM yyyy H:mm') }}"></th>
          <th><input ng-model="search.dataFile" placeholder="/"></th>
          <th>
            <select ng-model="search.status">
              <option value=''>Any</option>
              <option value='success'>Success</option>
              <option value='failure'>Failure</option>
            </select>
          </th>
          <th><input ng-model="search.pages"></th>
          <th><input ng-model="search.viewports"></th>
          <th><input ng-model="search.selectors"></th>
        </tr>
        <tr ng-repeat="report in filteredReports() | orderBy:'id':!reverseReports" ng-click="clickReport(report)" ng-mouseenter="hovered=true" ng-mouseleave="hovered=''" ng-class="{hovered:hovered, active:isActiveReport(report)}" class="{{report.status}}">
          <td>{{report.records.startTime}}</td>
          <td>{{report.records.startTime | date:'d MMM yyyy H:mm'}}</td>
          <td><a ng-href="{{report.options.dataFile}}" title="{{report.options.dataFile}}" target="_blank">{{report.options.dataFile | dataFileName}}</a></td>
          <td>{{report.status}}</td>
          <td>{{report.records.planned.pages}}</td>
          <td>{{report.records.planned.viewports}}</td>
          <td>{{report.records.planned.selectors}}</td>
        </tr>
      </tbody>
    </table>

    <div ng-show="{{!reports.length}}">No reports available (missing runs.json.inc). Succss automatically creates and updates a ./succss-reports/runs.json.inc file after each run.</div>

    <div class="current-report-title"><span ng-click="focusOnCurrent()" title="Focus reports table on this.">
        Selected report: <strong>{{activeReport.options.dataFile | dataFileName}}</strong> - {{activeReport.records.startTime | date:'d MMM yyyy H:mm:ss'}}
    </span></div>

    <div id="current-report-description">
      <div id="current-report-summary">
        <div>Status: <span class="{{activeReport.status}}">{{activeReport.status}}</span></div>
        <div>Planned captures: {{activeReport.records.planned.captures}}</div>
        <div>Captures taken: {{matches.length+differences.length}}</div>
        <div>Exec time: {{activeReport.records.execTime}}ms</div>
        <div>Errors: {{activeReport.records.errors.length}}</div>
        <div class="report-error" ng-repeat="error in (activeReport.records.errors | errorsString) track by $index">{{$index+1}}: {{error}}</div>
      </div>
      <div id="current-report-options">
        <h4>Options:</h4>
        <div class="options-list"><span ng-repeat="(key, option) in activeReport.options">--{{key}}: {{option}}<br/></span></div>
      </div>
    </div>

    <div id="active-check-report" class="active-report" ng-show="checkPageActive">
      <div id="current-report-differences" class="current-report-captures">
        <h3>Differences</h3>
        <div ng-repeat="capture in activeReport.records.captures | captureHasDifferences:true as differences" class="difference">
          <h4>--- {{capture.page.name}} ({{capture.page.url}}) --- {{capture.viewport.name}} ({{capture.viewport.width}}x{{capture.viewport.height}})</h4>
          <div><strong>Selector: {{capture.name}} ({{capture.selector}})</strong></div>
          <div><strong>Compared to: {{capture.comparedTo}}</strong></div>
          <div><strong>Image reference:</strong></div>
          <a ng-href="../{{capture.basePath}}" target="_blank" title="../{{capture.filePath}}"><img ng-src="../{{capture.basePath}}"/></a>
          <hr/>
        </div>
        <span ng-if="differences.length == 0">No differences found.</span>
      </div>
      <div id="current-report-matches" class="current-report-captures">
        <h3>Matches</h3>
        <div ng-repeat="capture in activeReport.records.captures | captureHasDifferences:false as matches" class="difference">
          <h4>--- {{capture.page.name}} ({{capture.page.url}}) --- {{capture.viewport.name}} ({{capture.viewport.width}}x{{capture.viewport.height}})</h4>
          <div><strong>Selector: {{capture.name}} ({{capture.selector}})</strong></div>
          <div><strong>Compared to: {{capture.comparedTo}}</strong></div>
          <div><strong>Image reference:</strong></div>
          <a ng-href="../{{capture.basePath}}" target="_blank" title="../{{capture.filePath}}"><img ng-src="../{{capture.basePath}}"/></a>
          <hr/>
        </div>
        <span ng-if="matches.length == 0">No matches found.</span>
      </div>
    </div>

    <div id="active-reference-list" class="active-report" ng-show="referencesPageActive">
      <table>
        <thead>
          <tr>
            <th>Page <button ng-click="reorderReferencesList('page.name')" title="Sort by page name">S</button></th>
            <th>Viewport <button ng-click="reorderReferencesList('viewport.width')" title="Sort by viewport width">S</button></th>
            <th>Capture <button ng-click="reorderReferencesList('name')" title="Sort by capture name">S</button></th>
            <th class="image-reference">Image</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="capture in activeReport.records.captures | orderByCapturesProps:refOrder">
            <td><a ng-href="{{capture.page.url}}" title="{{capture.page.url}}" target="_blank">{{capture.page.name}}</a></td>
            <td><div>"{{capture.viewport.name}}"</div><div class="details">Size: {{capture.viewport.width}}x{{capture.viewport.height}}</div></td>
            <td><div>"{{capture.name}}"</div><div class="details">Selector: {{capture.selector}}</div></td>
            <td class="image-reference"><a ng-href="{{capture.filePath | screenshotPath}}" target="_blank"><img ng-src="{{capture.filePath | screenshotPath}}"/></a></td>
          </tr>
        </tbody>
      </table>
    </div>

    <footer>
      <div>
        <a href="http://succss.ifzenelse.net" class="documentation-root" target="_blank">Online documentation: </a>
        <a href="http://succss.ifzenelse.net/usecases">Typical Use Cases - </a>
        <a href="http://succss.ifzenelse.net/configuration">Configuration - </a>
        <a href="http://succss.ifzenelse.net/commandline">CLI Options - </a>
        <a href="http://succss.ifzenelse.net/customize">Custom Validations</a>
      </div>
      <img class="footer-logo" src="http://succss.ifzenelse.net/img/arc-logo.png"/>
    </footer>

    <script type="text/javascript">
      if (typeof angular === 'undefined') {
        document.write('<script src="../node_modules/angular/angular.min.js"><\/script>');
      }
      if (typeof succssReports === 'undefined') {
        var succssReports = [];
      }
    </script>
    <script type="text/javascript">
      var reportRouter = function(location, reports) {
        var self = {};
        var defaultReport = { id: '0', options: { dataFile: 'No report found' }, captures: { errors: [] }};
        self.getReport = function(id) {
          for (var r in reports) {
            if (reports[r].id == id && reports[r].options.action == self.getAction()) return reports[r];
          }
          return false;
        }
        self.getMostRecentReport = function() {
          for (var i = 0; i < reports.length; i++) {
            if (reports[i].options.action == self.getAction()) return reports[i];
          }
          return defaultReport;
        }
        self.getActiveReport = function() {
          return self.getReport(location.path().split('/').slice(2,3)) || self.getMostRecentReport();
        }
        self.setPath = function(settings) {
          var page = settings && settings.page || self.getAction();
          if (page != 'check' && page != 'add') page = 'check';
          var reportId = settings && settings.id || self.getActiveReport().id;
          location.path(page + '/' + reportId);
        }
        self.getAction = function() {
          return location.path().split('/').slice(1,2).toString();
        }
        return self;
      }
      angular.module('succssReportsApp', [])
        .value('reports', succssReports)
        .filter('dataFileName', function() {
          return function(dataFilePath) {
            return dataFilePath.replace(/^.*\//g, '');
          }
        })
        .filter('screenshotPath', function() {
          return function(path) {
            if (path.indexOf('/') === 0) return path;
            return '../' + path.replace('./', '');
          }
        })
        .filter('captureHasDifferences', function() {
          return function(captures, hasDiff) {
            filteredCaptures = [];
            angular.forEach(captures, function(capture, key) {
              if (capture.differences.length && hasDiff || !hasDiff && !capture.differences.length) filteredCaptures.push(capture);
            });
            return filteredCaptures;
          }
        })
        .filter('errorsString', function() {
          return function(errors) {
            var formattedErrors = [];
            angular.forEach(errors, function(error, key) {
              error = JSON.parse(error);
              error.message ? formattedErrors.push(error.message) : formattedErrors.push(error);
            })
            return formattedErrors;
          }
        })
        .filter('orderByCapturesProps', function($filter) {
          return function(captures, refOrder) {
            capturesArray = [];
            angular.forEach(captures, function(capture, id) {
              capturesArray.push(capture);
            });
            return $filter('orderBy')(capturesArray, refOrder);
          }
        })
        .controller('ReportsListCtrl', function($scope, $filter, $location, $window, $anchorScroll, reports) {
          $scope.router = reportRouter($location, reports);
          $scope.router.setPath();
          $scope.activeReport = $scope.router.getActiveReport();
          $scope.referencesPageActive = $scope.checkPageActive = false;
          $scope.router.getAction() == 'add' ? $scope.referencesPageActive = true : $scope.checkPageActive = true;
          $scope.now = new Date().getTime();
          $scope.reports = reports;
          $scope.reverseReports = false;
          $scope.defaultRowLimit = 4;
          $scope.refOrder = 'name';
          $scope.search = {
            timestamp : '',
            dataFile : '',
            date: '',
            status: '',
            pages:'',
            viewports:'',
            captures:'',
          };
          $scope.filteredReports = function() {
            var filteredReports = [];
            var dateFilter = new Date($scope.search.date + ':');
            var rowLimit = !$scope.rowLimit ? $scope.defaultRowLimit : $scope.rowLimit;
            var reportsFilters = {
              status: $scope.search.status,
              records: {
                startTime:$scope.search.timestamp,
                planned: {
                  pages: $scope.search.pages,
                  viewports: $scope.search.viewports,
                  selectors: $scope.search.selectors || ''
                }
              },
              options: {
                action:$scope.router.getAction(),
                dataFile:$scope.search.dataFile,
              }
            };
            if (isNaN($scope.rowLimit)) $scope.rowLimit = $scope.defaultRowLimit;
            for (var r in $scope.reports) {
              if ($scope.reports[r].id < dateFilter.getTime() + 60001 || isNaN(dateFilter)) {
                filteredReports.push($scope.reports[r]);
              }
            }
            filteredReports = $filter('filter')(filteredReports, reportsFilters);
            filteredReports = $filter('limitTo')(filteredReports, rowLimit);
            return filteredReports;
          };
          $scope.reverseReportsOrder = function() {
            $scope.reverseReports = !$scope.reverseReports;
            $scope.rowLimit = $scope.rowLimit && $scope.rowLimit * -1;
          };
          $scope.clickReport = function(report) {
            $scope.activeReport = report;
            $scope.router.setPath({id: report.id});
          };
          $scope.isActiveReport = function(report) {
            return report.id == $scope.activeReport.id ? true : false ;
          }
          $scope.switchPage = function(action) {
            if ($scope.router.getAction() != action) {
              $scope.router.setPath({page:action});
              $scope.activeReport = $scope.router.getActiveReport();
              $scope.referencesPageActive = !$scope.referencesPageActive;
              $scope.checkPageActive = !$scope.checkPageActive;
            }
          }
          $scope.reorderReferencesList = function(value) {
            $scope.refOrder = $scope.refOrder.indexOf(value) == 0 ? '-' + $scope.refOrder : value;
          }
          $scope.scrollTop = function() { $anchorScroll(); }
        });
    </script>
  </body>
</html>