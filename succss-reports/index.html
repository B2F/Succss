<!DOCTYPE html>
<html ng-app="succssReportsApp">
  <head>
    <title>Succss reports</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script type="text/javascript" src="runs.json.inc"></script>
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:700" rel="stylesheet" type="text/css">
    <style type="text/css">
      body { position:relative; background-color: #EEEFF0; top: 70px; font-family: Roboto; margin-bottom: 70px; }
      header { top: 0; left: 0; color: #F5F5C4; }
      footer { bottom: 0; left: 0 }
      header, footer { position: fixed; height:65px; width:100%; background-color: #1C424F; z-index: 1000; font-family: Open Sans; }
      header h1 { position: relative; left: 11px; bottom: 36px; font-size: 47px; width: 350px; z-index:1; cursor:pointer; }
      header div.links { position: absolute; width: 622px; border-bottom: 2px solid #F5F5C4; bottom: 1px;}
      header div.links div { position:relative; left: 403px; text-align: center; background-color:#EBEAE1; border-radius: 2px 2px 0 0; display: inline-block; }
      header div.links div a { text-decoration: none; text-align: center; color: #3A3A3A; font-size: 13px; display:block; width: 100px; padding: 4px; }
      header div.links div a.active { font-size: 16px; color: black; }
      #rowLimit { padding: 0 0 10px 0; }
      #rowLimit input { position: relative; width: 44px; bottom: 1px; margin-left: 3px; z-index:0; }
      table { font-family: sans-serif; border-spacing: 0px; width: 98%; }
      table thead { line-height: 1.8; background-color: #FFE; font-size: 15px; }
      table thead th { border-bottom: 1px solid #777; }
      table tbody { cursor: pointer; }
      table tbody tr:first-child { background-color: #FFFFCF; }
      table th, td { padding: 5px 7px ; border-bottom: 1px solid #EEEFF0; border-right: 1px dotted #EEEFF0; }
      table tr { text-align: left; }
      table tr.success { background-color: #C7FFC8; }
      table tr.failure { background-color: #FF9CB5; }
      table tr.hovered { background-color: #FCFFC7; }
      table tr.success.active td { border-bottom: 1px solid #090; border-top: 1px solid #0A0; }
      table tr.failure.active td { border-bottom: 1px solid #900; border-top: 1px solid #A00; }
      div#current-report-title { margin: 15px 0; }
      div#current-report-title span, h3 { font-size: 20px; padding-bottom: 5px; border-bottom: 1px solid black; display: inline-block; }
      div#current-report-description > div { display: inline-block; height: 136px; overflow:auto; margin-top: 5px; }
      div#current-report-summary { font-size: 18px; }
      div#current-report-summary span.success { color: #0C0; font-family: sans-serif; font-weight:bold; }
      div#current-report-summary span.failure { color: #C00; font-family: sans-serif; font-weight:bold; }
      div#current-report-options { margin-left: 30px; }
      div#current-report-options div { color: white; background-color: #214F5E; padding: 3px 0 5px 6px; }
      div#active-report div.current-report-captures { width: 50%; float: left; margin-bottom: 43px; }
      div#current-report-options span { display: block; color: white; background-color: #307389; padding: 4px 5px; border-bottom: 1px dotted #214F5E; font-family: sans-serif; }
      div#active-report div.current-report-captures div.difference { border-left: 2px solid black; padding: 0 0 12px 7px; font-family: sans-serif; font-size:13px; }
      div#active-report div.current-report-captures h4 { font-size: 14px; margin: 0; }
      div#active-report div.current-report-captures img, div#current-report-differences div.difference a { max-width:97%; display: block; }
      footer { height: 45px; }
      footer a { color:white; text-decoration:none; font-size: 13px; display: inline-block; padding: 11px 0; }
      footer a.documentation-root { color: #F5F5C4; font-size: 17px ; text-decoration: underline; padding-left: 12px; padding-right: 6px; }
      footer img.footer-logo { transition: all 1s ease-in-out; transition-timing-function: cubic-bezier(42,0,.58,1); }
      footer:hover img.footer-logo { transform:translateY(-58px); opacity: 0.7; }
      footer img.footer-logo { position:absolute; float:right; right: 11px; bottom: -90px; }
      footer div { border-top: 1px solid #F5F5C4; margin-top: 1px; }
    </style>
  </head>
  <body ng-controller="ReportsListCtrl">
    <header>
      <h1 ng-click="scrollTop()" title="Scroll back top">Succss reports</h1>
      <div class="links">
        <div><a href="#/check" ng-click="reload()" ng-class="{active:(router.getPageType() == 'check')}">Check</a></div>
        <div><a href="#/references" ng-click="reload()" ng-class="{active:(router.getPageType() == 'references')}">References</a></div>
      </div>
    </header>

    <div id="rowLimit"><label>Reports row limit: </label><input ng-model="rowLimit" placeholder={{defaultRowLimit}} type="number"></div>
    <!--<div id="dataFile"><label>Data file:</label><input type="text"  /></div>-->

    <table>
      <thead>
        <th>Timestamp</th><th>Date</th><th>Config file</th><th>Status</th><th>--pages</th><th>--viewports</th><th>--captures</th>
      </thead>
      <tbody>
        <tr>
          <th><input ng-model="search.timestamp"><button ng-click="reverseReportsOrder()">Reverse</button></th>
          <th><input ng-model="search.date"></th>
          <th><input ng-model="search.dataFile"></th>
          <th>
            <select ng-model="search.status">
              <option>Any</option>
              <option>Success</option>
              <option>Failure</option>
            </select>
          </th>
          <th><input ng-model="search.pages"></th>
          <th><input ng-model="search.viewports"></th>
          <th><input ng-model="search.captures"></th>        
        </tr>
        <tr ng-repeat="report in filteredReports() | limitTo:reportsRowsNb | orderBy:'id':!reverseReports" ng-click="clickReport(report)" ng-mouseenter="hovered=true" ng-mouseleave="hovered=''" ng-class="{hovered:hovered, active:isActive(report)}" class="{{report.captures | status | lowercase}}">
          <td>{{report.count.startTime}}</td>
          <td>{{report.count.startTime | date:'d MMM yyyy H:mm'}}</td>
          <td><a ng-href="{{report.options.dataFile}}" title="{{report.options.dataFile}}" target="_blank">{{report.options.dataFile | dataFileName}}</a></td>
          <td>{{report.captures | status}}</td>
          <td>{{report.options.pages}}</td>
          <td>{{report.options.viewports}}</td>
          <td>{{report.options.captures}}</td>
        </tr>
      <div ng-show="{{!reports.length}}">No reports available (missing runs.json.inc). Succss automatically creates and updates a ./succss-reports/runs.json.inc file after each run.</div>
      </tbody>
    </table>

    <div id="active-report" ng-show="router.getPageType() != 'references'">
      <div id="current-report-title"><span>Selected report: <strong>{{activeReport.options.dataFile | dataFileName}}</strong> - {{activeReport.count.startTime | date:'d MMM yyyy H:mm:ss'}}</span></div>
      <div id="current-report-description">
        <div id="current-report-summary">
          <div>Status: <span class="{{activeReport.captures | status | lowercase}}">{{activeReport.captures | status | lowercase}}</span></div>
          <div>Planned captures: {{activeReport.count.planned}}</div>
          <div>Failures: {{activeReport.captures.failures.length}}</div>
          <div>Success: {{activeReport.captures.success.length}}</div>
          <div>Exec time: {{activeReport.count.startTime | date:''}}</div>
        </div>
        <div id="current-report-options">
          <div>Options:</div>
          <span ng-repeat="(key, option) in activeReport.options">--{{key}}: {{option}}<br/></span>
        </div>
      </div>
      <div id="current-report-differences" class="current-report-captures">
        <h3>Differences</h3>
        <span ng-hide="activeReport.captures.failures.length">No differences found.</span>
        <div ng-repeat="failure in activeReport.captures.failures" class="difference">
          <h4>--- {{failure.page.name}} ({{failure.page.url}}) -- {{failure.viewport.name}} ({{failure.viewport.width}}x{{failure.viewport.height}})</h4>
          <h5>{{failure.name}} ({{failure.selector}})</h5>
          <strong>Compared to:</strong> 
          <strong>File reference:</strong> {{failure.basePath}}
          {Difftype}
          <a ng-href="../{{failure.imgDiff}}" target="_blank" title="../{{failure.imgDiff}}"><img ng-src="../{{failure.imgDiff}}"/></a>
        </div>
      </div>
      <div id="current-report-matches" class="current-report-captures">
        <h3>Matches</h3>
        <span ng-hide="activeReport.captures.success.length">No matches found.</span>
        <div ng-repeat="success in activeReport.captures.success" class="difference">
          <h4>--- {{success.page.name}} ({{success.page.url}}) -- {{success.viewport.name}} ({{success.viewport.width}}x{{success.viewport.height}})</h4>
          <h5>{{success.name}} ({{success.selector}})</h5>
          <strong>Compared to:</strong> 
          <strong>File reference:</strong> {{success.basePath}}
          <a ng-href="../{{success.basePath}}" target="_blank" title="../{{failure.imgDiff}}"><img ng-src="../{{success.basePath}}"/></a>
        </div>
      </div>
    </div>

    <footer>
      <div>
        <a href="http://succss.ifzenelse.net" class="documentation-root" target="_blank">Online documentation: </a>
        <a href="http://succss.ifzenelse.net/usecases">Typical Use Cases - </a>
        <a href="http://succss.ifzenelse.net/configuration">Configuration - </a>
        <a href="http://succss.ifzenelse.net/commandline">CLI Options - </a>
        <a href="http://succss.ifzenelse.net/customize">Custom Validations</a>
      </div>
      <img class="footer-logo" src="http://succss.ifzenelse.net/img/arc-logo.png"/>
    </footer>

    <div ng-show="false">
      Succss reporting functionality requires Angularjs 1.3.14. Either type the following in your working succss directory:
      <pre>npm install angular@1.3.14</pre>
      Or get network access to https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angulars.min.js.
    </div>

    <script type="text/javascript">
      if (typeof angular === 'undefined') {
        document.write('<script src="../node_modules/angular/angular.min.js"><\/script>');
      }
      if (typeof succssReports === 'undefined') {
        var succssReports = [];
      }
    </script>
    <script type="text/javascript">
      var reportRouter = function(location, reports) {
        var self = {};
        var path = location || '/check';
        var components = path.split('/'); components.shift();
        var pageType = ['check', 'references'].indexOf(components[0]) != -1 ? components[0] : 'check';
        self.getReport = function(id) {
          for (var r in reports) {
            if (reports[r].id == id && reports[r].options.action == 'check') return reports[r];
          }
          return false;
        }
        self.getMostRecentReport = function() {
          return reports[0];
        }
        self.getActiveReport = function() {
          return self.getReport(components[1]) || self.getMostRecentReport();
        }
        self.getPath = function() {
          return pageType == 'check' ? pageType + '/' + self.getActiveReport().id : pageType;
        }
        self.getPageType = function() { return pageType };
        self.updateCheckPath = function(reportId) {
          return pageType + '/' + reportId;
        }
        return self;
      }
      angular.module('succssReportsApp', [])
        .value('reports', succssReports)
        .filter('status', function() {
          return function(captures) {
            return captures.failures.length ? 'Failure' : 'Success';
          }
        })
        .filter('dataFileName', function() {
          return function(dataFilePath) {
            return dataFilePath.replace(/^.*\//g, '');
          }
        })
        .controller('ReportsListCtrl', function($scope, $filter, $location, $window, $anchorScroll, reports) {
          $scope.router = reportRouter($location.path(), reports);
          $location.path($scope.router.getPath());
          $scope.reports = reports;
          $scope.activeReport = $scope.router.getActiveReport();
          $scope.reverseReports = false;
          $scope.defaultRowLimit = 3;
          $scope.search = {
            timestamp : '',
            dataFile : '/',
            date: '<=   ' + $filter('date')(Date.now(), 'd MMM yyyy H:mm'),
            status: 'Any',
            pages:'',
            viewports:'',
            captures:'',
          };
          $scope.filteredReports = function() {
            $scope.reportsRowsNb = !$scope.rowLimit ? $scope.defaultRowLimit : $scope.rowLimit;
            var dateFilter = new Date($scope.search.date + ':');
            var results = [];
            if (isNaN($scope.rowLimit)) $scope.rowLimit = $scope.defaultRowLimit;
            for (var r in $scope.reports) {
              var pushReport = true;
              if (($scope.reports[r].options.action != $scope.router.getPageType()) ||
//                  ($scope.reports[r].id > dateFilter.getTime() + 60001 && !isNaN(dateFilter)) ||
                  ($scope.search.status != 'Any' && $filter('status')($scope.reports[r].captures) !== $scope.search.status)) { pushReport = false; }
              if (pushReport) results.push($scope.reports[r]);
            }
            var filters = {
              count: {
                startTime:$scope.search.timestamp,
              },
              options: {
                dataFile:$scope.search.dataFile,
                pages:$scope.search.pages,
                viewports:$scope.search.viewports,
                captures:$scope.search.captures
              }
            };
            return $filter('filter')(results, filters);
          };
          $scope.reverseReportsOrder = function() {
            $scope.reverseReports = !$scope.reverseReports;
            $scope.rowLimit = $scope.rowLimit * -1;
          };
          $scope.clickReport = function(report) {
            angular.forEach($scope.reports, function(value, key) {
              $scope.reports[key].active = '';
            });
            $scope.activeReport = report;
            $location.path($scope.router.updateCheckPath(report.id));
          };
          $scope.isActive = function(report) {
            return report.id == $scope.activeReport.id ? true : false ;
          }
          $scope.reload = function() { $window.location.reload() }
          $scope.scrollTop = function() { $anchorScroll(); }
        });
    </script>
  </body>
</html>