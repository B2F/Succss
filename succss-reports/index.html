<!DOCTYPE html>
<html ng-app="succssReportsApp">
  <head>
    <title>Succss reports</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script type="text/javascript" src="runs.json.inc"></script>
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:700" rel="stylesheet" type="text/css">
    <style type="text/css">
      body { position:relative; background-color: #EEEFF0; top: 70px; font-family: Roboto; margin-bottom: 70px; }
      .page-load-error { color: #F00; font-size: 1.3em; margin: 3%;}
      header { top: 0; left: 0; color: #F5F5C4; }
      header, footer { position: fixed; height:65px; width:100%; background-color: #1C424F; z-index: 1000; font-family: Open Sans; }
      header h1 { position: relative; left: 11px; bottom: 36px; font-size: 47px; width: 350px; z-index:1; cursor:pointer; }
      header div.links { position: absolute; padding-left: 371px; border-bottom: 2px solid #F5F5C4; bottom: 1px;}
      header div.links div div { position:relative; text-align: center; background-color:#EBEAE1; border-radius: 2px 2px 0 0; display: inline-block; }
      header div.links div div a { text-decoration: none; text-align: center; color: #3A3A3A; font-size: 13px; display:block; width: 100px; padding: 4px; }
      header div.links div div a.active { font-size: 16px; color: black; }
      #rowLimit { padding: 0 0 10px 0; }
      #rowLimit input { position: relative; width: 44px; bottom: 1px; margin-left: 3px; z-index:0; }
      table { font-family: sans-serif; margin-top: 10px; border-spacing: 0px; width: 98%; table-layout: fixed; overflow: hidden; }
      table thead { line-height: 2.3; background-color: #FFE; font-size: 12px; }
      table thead th { border-bottom: 1px solid #777; }
      table thead .search.timestamp { width: 125px; position:relative; }
      table thead .search.timestamp button { position: absolute; right: 0; }
      table thead .search.date { width: 115px; }
      table thead .search.config { width: 125px; }
      table thead .search.status { width: 67px; }
      table tbody { cursor: pointer; font-size: 11px; }
      table tbody tr:first-child { background-color: #FFFFCF; }
      table tbody tr input, table tbody tr select { width: 95%; margin-right: 1%; font-size: 10px; }
      table tbody tr button { width: 25px; }
      table th, td { padding: 5px 7px ; border-bottom: 1px solid #EEEFF0; border-right: 1px dotted #EEEFF0; }
      table tr { text-align: left; line-height: 1.5; }
      table tr.success { background-color: #C7FFC8; }
      table tr.failure { background-color: #FF9CB5; }
      table tr.success.active { background-color: #B2F1B2; font-weight: bold; }
      table tr.failure.active { background-color: #F78FAB; font-weight: bold; }
      table tr.success.hovered, table tr.failure.hovered { background-color: #FCFFC7; }
      div.current-report-title { margin: 15px 0; }
      div.current-report-title span, h3 { font-size: 20px; padding-bottom: 5px; border-bottom: 1px solid black; display: inline-block; }
      div#current-report-description > div { display: inline-block; height: 136px; overflow:auto; margin-top: 5px; }
      div#current-report-summary { font-size: 18px; }
      div#current-report-summary span.success { color: #0C0; font-family: sans-serif; font-weight:bold; }
      div#current-report-summary span.failure { color: #C00; font-family: sans-serif; font-weight:bold; }
      div#current-report-options { margin-left: 30px; }
      div#current-report-options div { color: white; background-color: #214F5E; padding: 3px 0 5px 6px; }
      div#active-report div.current-report-captures { width: 50%; float: left; margin-bottom: 71px; }
      div#current-report-options span { display: block; color: white; background-color: #307389; padding: 4px 5px; border-bottom: 1px dotted #214F5E; font-family: sans-serif; }
      div#active-report div.current-report-captures div.difference { border-left: 2px solid black; padding: 0 0 12px 7px; font-family: sans-serif; font-size:13px; }
      div#active-report div.current-report-captures h4 { font-size: 14px; margin: 0; }
      div#current-report-differences div.difference a, td.image-reference a img { max-width:97%; max-height:300px; }
      div#active-reference-list table th:not(.image-reference) { width: 10%; }
      div#active-reference-list table td { text-align: center; vertical-align: top; font-size: 12px; }
      footer { height: 45px; bottom: 0; left: 0 }
      footer a { color:white; text-decoration:none; font-size: 13px; display: inline-block; padding: 11px 0; }
      footer a.documentation-root { color: #F5F5C4; font-size: 17px ; text-decoration: underline; padding-left: 12px; padding-right: 6px; }
      footer img.footer-logo { transition: all 1s ease-in-out; transition-timing-function: cubic-bezier(42,0,.58,1); }
      footer:hover img.footer-logo { transform:translateY(-58px); opacity: 0.7; }
      footer img.footer-logo { position:absolute; float:right; right: 11px; bottom: -90px; }
      footer div { border-top: 1px solid #F5F5C4; margin-top: 1px; }
    </style>
  </head>
  <body ng-controller="ReportsListCtrl">

    <div ng-show="false" class="page-load-error">
      Succss reporting functionality requires Angularjs 1.3.14. Either type the following in your working succss directory:
      <pre>npm install angular@1.3.14</pre>
      Or get network access to https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angulars.min.js.
    </div>

    <header>
      <h1 ng-click="scrollTop()" title="Scroll back top">Succss reports</h1>
      <div class="links">
        <div class="links-container">
          <div><a href="#/check" ng-click="switchPage('check')" ng-class="{active:checkPageActive}">Check</a></div>
          <div><a href="#/add" ng-click="switchPage('add')" ng-class="{active:referencesPageActive}">References</a></div>
        </div>
      </div>
    </header>

    <div id="rowLimit"><label>Reports row limit: </label><input ng-model="rowLimit" placeholder={{defaultRowLimit}} type="number"></div>
    <!--<div id="dataFile"><label>Data file:</label><input type="text"  /></div>-->

    <table>
      <thead>
        <th class="search timestamp">Timestamp <button ng-click="reverseReportsOrder()" title="Reverse order by date">R</button></th>
        <th class="search date">Date</th>
        <th class="search config">Config file</th>
        <th class="search status">Status</th>
        <th class="search pages">--pages</th>
        <th class="search viewports">--viewports</th>
        <th class="search captures">--captures</th>
      </thead>
      <tbody>
        <tr>
          <th><input ng-model="search.timestamp"></th>
          <th><input ng-model="search.date"></th>
          <th><input ng-model="search.dataFile"></th>
          <th>
            <select ng-model="search.status">
              <option value=''>Any</option>
              <option value='success'>Success</option>
              <option value='failure'>Failure</option>
            </select>
          </th>
          <th><input ng-model="search.pages"></th>
          <th><input ng-model="search.viewports"></th>
          <th><input ng-model="search.selectors"></th>
        </tr>
        <tr ng-repeat="report in filteredReports() | orderBy:'id':!reverseReports" ng-click="clickReport(report)" ng-mouseenter="hovered=true" ng-mouseleave="hovered=''" ng-class="{hovered:hovered, active:isActiveReport(report)}" class="{{report.status}}">
          <td>{{report.records.startTime}}</td>
          <td>{{report.records.startTime | date:'d MMM yyyy H:mm'}}</td>
          <td><a ng-href="{{report.options.dataFile}}" title="{{report.options.dataFile}}" target="_blank">{{report.options.dataFile | dataFileName}}</a></td>
          <td>{{report.status}}</td>
          <td>{{report.records.planned.pages}}</td>
          <td>{{report.records.planned.viewports}}</td>
          <td>{{report.records.planned.selectors}}</td>
        </tr>
      </tbody>
    </table>

    <div ng-show="{{!reports.length}}">No reports available (missing runs.json.inc). Succss automatically creates and updates a ./succss-reports/runs.json.inc file after each run.</div>

    <div id="active-report" ng-show="checkPageActive">
      <div class="current-report-title"><a><span>Selected report: <strong>{{activeReport.options.dataFile | dataFileName}}</strong> - {{activeReport.records.startTime | date:'d MMM yyyy H:mm:ss'}}</span></a></div>
      <div id="current-report-description">
        <div id="current-report-summary">
          <div>Status: <span class="{{activeReport.status}}">{{activeReport.status}}</span></div>
          <div>Planned captures: {{activeReport.records.planned}}</div>
          <div>Captures: {{Object.keys(activeReport.records.captures).length}}</div>
          <div>Errors: {{activeReport.records.errors.length}} ({{activeReport.records.errors}}</div>
          <div>Exec time: {{activeReport.records.execTime}}ms</div>
        </div>
        <div id="current-report-options">
          <div>Options:</div>
          <span ng-repeat="(key, option) in activeReport.options">--{{key}}: {{option}}<br/></span>
        </div>
      </div>
      <div id="current-report-differences" class="current-report-captures">
        <h3>Differences</h3>
        <span ng-hide="activeReport.captures.failures.length">No differences found.</span>
        <div ng-repeat="capture in filteredDifferences()" class="difference">
          <h4>--- {{failure.page.name}} ({{failure.page.url}}) --- {{failure.viewport.name}} ({{failure.viewport.width}}x{{failure.viewport.height}})</h4>
          <h5>{{failure.name}} ({{failure.selector}})</h5>
          <strong>Compared to:</strong>
          <strong>File reference:</strong> {{failure.basePath}}
          {Difftype}
          <a ng-href="../{{failure.imgDiff}}" target="_blank" title="../{{failure.imgDiff}}"><img ng-src="../{{failure.imgDiff}}"/></a>
        </div>
      </div>
      <div id="current-report-matches" class="current-report-captures">
        <h3>Matches</h3>
        <span ng-hide="activeReport.captures.length">No matches found.</span>
        <div ng-repeat="capture in filteredMatches()" class="difference">
          <h4>--- {{capture.page.name}} ({{capture.page.url}}) --- {{capture.viewport.name}} ({{capture.viewport.width}}x{{capture.viewport.height}})</h4>
          <div><strong>Selector: {{capture.name}} ({{capture.selector}})</strong></div>
          <div><strong>Compared to: {{capture.comparedTo}}</strong></div>
          <div><strong>Image reference:</strong></div>
          <a ng-href="../{{capture.basePath}}" target="_blank" title="../{{capture.filePath}}"><img ng-src="../{{capture.basePath}}"/></a>
          <hr/>
        </div>
      </div>
    </div>

    <div id="active-reference-list" ng-show="referencesPageActive">
      <div class="current-report-title"><a><span>Selected report: <strong>{{activeReport.options.dataFile | dataFileName}}</strong> - {{activeReport.records.startTime | date:'d MMM yyyy H:mm:ss'}}</span></a></div>
      <table>
        <thead>
          <tr>
            <th>Page</th><th>Viewport</th><th>Capture</th><th class="image-reference">Image</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="capture in activeReport.records.captures">
            <td><a ng-href="{{capture.page.url}}" title="{{capture.page.url}}" target="_blank">{{capture.page.name}}</a></td>
            <td><div>"{{capture.viewport.name}}"</div><div>Size: {{capture.viewport.width}}x{{capture.viewport.height}}</div></td>
            <td><div>"{{capture.name}}"</div><div>Selector: {{capture.selector}}</div></td>
            <td class="image-reference"><a ng-href="{{capture.filePath | screenshotPath}}" target="_blank"><img ng-src="{{capture.filePath | screenshotPath}}"/></a></td>
          </tr>
        </tbody>
      </table>
      {{ activeReport }}
    </div>

    <footer>
      <div>
        <a href="http://succss.ifzenelse.net" class="documentation-root" target="_blank">Online documentation: </a>
        <a href="http://succss.ifzenelse.net/usecases">Typical Use Cases - </a>
        <a href="http://succss.ifzenelse.net/configuration">Configuration - </a>
        <a href="http://succss.ifzenelse.net/commandline">CLI Options - </a>
        <a href="http://succss.ifzenelse.net/customize">Custom Validations</a>
      </div>
      <img class="footer-logo" src="http://succss.ifzenelse.net/img/arc-logo.png"/>
    </footer>

    <script type="text/javascript">
      if (typeof angular === 'undefined') {
        document.write('<script src="../node_modules/angular/angular.min.js"><\/script>');
      }
      if (typeof succssReports === 'undefined') {
        var succssReports = [];
      }
    </script>
    <script type="text/javascript">
      var reportRouter = function(location, reports) {
        var self = {};
        var defaultReport = { id: '0', options: { dataFile: 'No report found' }, captures: { errors: [] }};
        self.getReport = function(id) {
          for (var r in reports) {
            if (reports[r].id == id && reports[r].options.action == self.getAction()) return reports[r];
          }
          return false;
        }
        self.getMostRecentReport = function() {
          for (var i = 0; i < reports.length; i++) {
            if (reports[i].options.action == self.getAction()) return reports[i];
          }
          return defaultReport;
        }
        self.getActiveReport = function() {
          return self.getReport(location.path().split('/').slice(2,3)) || self.getMostRecentReport();
        }
        self.setPath = function(settings) {
          var page = settings && settings.page || self.getAction();
          if (page != 'check' && page != 'add') page = 'check';
          var reportId = settings && settings.id || self.getActiveReport().id;
          location.path(page + '/' + reportId);
        }
        self.getAction = function() {
          return location.path().split('/').slice(1,2).toString();
        }
        return self;
      }
      angular.module('succssReportsApp', [])
        .value('reports', succssReports)
        .filter('status', function() {
          return function(report) {
            if (!report || !report.records || !report.records.captures || report.records.errors == 'undefined') return 'incomplete';
            return report.records.errors && report.records.errors.length ? 'Failure' : 'Success';
          }
        })
        .filter('dataFileName', function() {
          return function(dataFilePath) {
            return dataFilePath.replace(/^.*\//g, '');
          }
        })
        .filter('inScreenshotsReferences', function() {
          return function(path) {
            return path.replace('succss-reports', '');
          }
        })
        .controller('ReportsListCtrl', function($scope, $filter, $location, $window, $anchorScroll, reports) {
          $scope.router = reportRouter($location, reports);
          $scope.router.setPath();
          $scope.activeReport = $scope.router.getActiveReport();
          $scope.referencesPageActive = $scope.checkPageActive = false;
          $scope.router.getAction() == 'add' ? $scope.referencesPageActive = true : $scope.checkPageActive = true;
          $scope.reports = reports;
          $scope.reverseReports = false;
          $scope.defaultRowLimit = 3;
          $scope.search = {
            timestamp : '',
            dataFile : '/',
            date: '<= ' + $filter('date')(Date.now(), 'd MMM yyyy H:mm'),
            status: '',
            pages:'',
            viewports:'',
            captures:'',
          };
          $scope.filteredReports = function() {
            var filteredReports = [];
            var rowLimit = !$scope.rowLimit ? $scope.defaultRowLimit : $scope.rowLimit;
            var dateFilter = new Date($scope.search.date + ':');
            if (isNaN($scope.rowLimit)) $scope.rowLimit = $scope.defaultRowLimit;
            var reportsFilters = {
              status: $scope.search.status,
              records: {
                startTime:$scope.search.timestamp,
              },
              options: {
                action:$scope.router.getAction(),
                dataFile:$scope.search.dataFile,
                pages:$scope.search.pages,
                viewports:$scope.search.viewports,
                captures:$scope.search.selectors
              }
            };
            filteredReports = $filter('filter')($scope.reports, reportsFilters);
            filteredReports = $filter('limitTo')(filteredReports, rowLimit);
            for (var r in filteredReports) {
              var reportPages = filteredReports[r].records.planned.pages.join();
              var reportViewports = filteredReports[r].records.planned.viewports.join();
              var reportSelectors = filteredReports[r].records.planned.selectors.join();
              if ((filteredReports[r].id > dateFilter.getTime() + 60001 && !isNaN(dateFilter)) ||
                  ($scope.search.pages && reportPages.indexOf($scope.search.pages) == -1) ||
                  ($scope.search.viewports && reportViewports.indexOf($scope.search.viewports) == -1) ||
                  ($scope.search.selectors && reportSelectors.indexOf($scope.search.selectors) == -1) ) {
                delete filteredReports[r];
              }
            }
            return filteredReports;
          };
          $scope.reverseReportsOrder = function() {
            $scope.reverseReports = !$scope.reverseReports;
            $scope.rowLimit = $scope.rowLimit * -1;
          };
          $scope.clickReport = function(report) {
            $scope.activeReport = report;
            $scope.router.setPath({id: report.id});
          };
          $scope.isActiveReport = function(report) {
            return report.id == $scope.activeReport.id ? true : false ;
          }
          $scope.switchPage = function(action) {
            if ($scope.router.getAction() != action) {
              $scope.router.setPath({page:action});
              $scope.activeReport = $scope.router.getActiveReport();
              $scope.referencesPageActive = !$scope.referencesPageActive;
              $scope.checkPageActive = !$scope.checkPageActive;
            }
          }
          $scope.scrollTop = function() { $anchorScroll(); }
        });
    </script>
  </body>
</html>